
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>二分查找</title>
   <meta name="author" content="Huang Chao" />
   <link href="http://feeds.feedburner.com/feedname" rel="alternate" title="your title" type="application/atom+xml" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/highlight.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/assets/themes/tom/css/screen.css" type="text/css" media="screen, projection" />

</head>
<body>

  <div class="site">
    <div class="title">
      <a href="/">HuangChao's Blog</a>

      <a class="extra" href="/archive.html">Archive</a>
      <a class="extra" href="">Pages</a>
      <a class="extra" href="/categories.html">Categories</a>
      <a class="extra" href="/tags.html">Tags</a>
    </div>
  
    
<div id="post">
  <h1>二分查找</h1>
  <p class="meta">
    02 March 2011 
    
  </p>
  <p>以前学的时候也没好好研究，只是大概知道思想，昨天写程序的时候发现bug了，十分惭愧，结果在网上发现了这样资料：</p>

<blockquote>
<p>二分查找可以解决（预排序数组的查找）问题：只要数组中包含T（即要查找的值），那么通过不断缩小包含T的范围，最终就可以找到它。一开始，范围覆盖整个数组。将数组的中间项与T进行比较，可以排除一半元素，范围缩小一半。就这样反复比较，反复缩小范围，最终就会在数组中找到T，或者确定原以为T所在的范围实际为空。对于包含N个元素的表，整个查找过程大约要经过log(2)N次比较。 多数程序员都觉得只要理解了上面的描述，写出代码就不难了；但事实并非如此。如果你不认同这一点，最好的办法就是放下书本，自己动手写一写。试试吧。 我在贝尔实验室和IBM的时候都出过这道考题。那些专业的程序员有几个小时的时间，可以用他们选择的语言把上面的描述写出来；写出高级伪代码也可以。考试结束后，差不多所有程序员都认为自己写出了正确的程序。于是，我们花了半个钟头来看他们编写的代码经过测试用例验证的结果。几次课，一百多人的结果相差无几：90%的程序员写的程序中有bug（我并不认为没有bug的代码就正确）。 我很惊讶：在足够的时间内，只有大约10%的专业程序员可以把这个小程序写对。但写不对这个小程序的还不止这些人：高德纳在《计算机程序设计的艺术 第3卷 排序和查找》第6.2.1节的“历史与参考文献”部分指出，虽然早在1946年就有人将二分查找的方法公诸于世，但直到1962年才有人写出没有bug的二分查找程序。 – 乔恩.本特利，《编程珠玑（第1版）》第35-36页</p>
</blockquote>

<p>只有10%的程序员可以写出正确的二分查找程序，看来我还不属于这10%。</p>

<p>当时错误的原因很简单，就是一个小小的bug陷入的死循环：</p>
<div class='highlight'><pre><code class='c++'>    <span class='kt'>int</span> <span class='nf'>bSearch</span><span class='p'>(</span><span class='n'>vector</span><span class='o'>&lt;</span><span class='kt'>int</span><span class='o'>&gt;</span><span class='n'>a</span><span class='p'>,</span><span class='kt'>int</span> <span class='n'>x</span><span class='p'>)</span>
    <span class='p'>{</span>
        <span class='kt'>int</span> <span class='n'>l</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>,</span><span class='n'>r</span><span class='o'>=</span><span class='n'>a</span><span class='p'>.</span><span class='n'>size</span><span class='p'>()</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='kt'>int</span> <span class='n'>mid</span><span class='o'>=</span><span class='p'>(</span><span class='n'>l</span><span class='o'>+</span><span class='n'>r</span><span class='p'>)</span><span class='o'>/</span><span class='mi'>2</span><span class='p'>;</span>
        <span class='k'>while</span><span class='p'>(</span><span class='n'>l</span><span class='o'>&lt;</span><span class='n'>r</span><span class='p'>)</span>
        <span class='p'>{</span>
            <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>=</span><span class='n'>mid</span><span class='p'>;</span>
            <span class='k'>else</span> <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>&gt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>r</span><span class='o'>=</span><span class='n'>mid</span><span class='p'>;</span>
            <span class='k'>else</span> <span class='k'>break</span><span class='p'>;</span>
            <span class='n'>mid</span><span class='o'>=</span><span class='p'>(</span><span class='n'>l</span><span class='o'>+</span><span class='n'>r</span><span class='p'>)</span><span class='o'>/</span><span class='mi'>2</span><span class='p'>;</span>
        <span class='p'>}</span>
        <span class='k'>return</span> <span class='n'>mid</span><span class='p'>;</span>
    <span class='p'>}</span>
    
</code></pre></div>
<p>乍一看是正确的，但是会陷入死循环，比如一个<code>vector&lt;int&gt;a</code>,从大到小存了9个数，设为1到9，现在要找到9的位置，那么执行上述代码时，mid依次为4,6,7,7,7…，陷入死循环。</p>

<p>正确的方法是将第7,8句修改，变成l=mid+1,r=mid-1,当然，这是保证x在a里的时候，如果x有可能不在a中，那么正确而且完整的代码如下(参考《编程珠玑(第二版)》第87页)：</p>
<div class='highlight'><pre><code class='c++'>    <span class='kt'>int</span> <span class='nf'>bSearch</span><span class='p'>(</span><span class='n'>vector</span><span class='o'>&lt;</span><span class='kt'>int</span><span class='o'>&gt;</span><span class='n'>a</span><span class='p'>,</span><span class='kt'>int</span> <span class='n'>x</span><span class='p'>)</span>
    <span class='p'>{</span>
        <span class='kt'>int</span> <span class='n'>l</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>,</span><span class='n'>r</span><span class='o'>=</span><span class='n'>a</span><span class='p'>.</span><span class='n'>size</span><span class='p'>()</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='kt'>int</span> <span class='n'>mid</span><span class='p'>;</span>
        <span class='k'>for</span><span class='p'>(;;)</span>
        <span class='p'>{</span>
            <span class='k'>if</span><span class='p'>(</span><span class='n'>l</span><span class='o'>&gt;</span><span class='n'>r</span><span class='p'>)</span> <span class='k'>return</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
            <span class='n'>mid</span><span class='o'>=</span><span class='p'>(</span><span class='n'>l</span><span class='o'>+</span><span class='n'>r</span><span class='p'>)</span><span class='o'>/</span><span class='mi'>2</span><span class='p'>;</span>
            <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>=</span><span class='n'>mid</span><span class='o'>+</span><span class='mi'>1</span><span class='p'>;</span>
            <span class='k'>else</span> <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>==</span><span class='n'>x</span><span class='p'>)</span> <span class='k'>return</span> <span class='n'>mid</span><span class='p'>;</span>
            <span class='k'>else</span> <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>&gt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>r</span><span class='o'>=</span><span class='n'>mid</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='p'>}</span>
        <span class='k'>return</span> <span class='n'>mid</span><span class='p'>;</span>
    <span class='p'>}</span>
    
</code></pre></div>
<p>然后我看到了一道课后题：用二分法返回数组a中出现的第一个x的位置，我是这样想的：</p>

<p>在上面的基础上进行改进，如果已经搜到x的一个位置，那么如果x的前一个位置比x小，则意味着第一个x已经找到，如果前一个位置也是x，那么将r修改为mid-1;需要注意的是，如果mid==0，则直接判断mid是否是x即可，代码如下：</p>
<div class='highlight'><pre><code class='c++'>    <span class='kt'>int</span> <span class='nf'>bSearch2</span><span class='p'>(</span><span class='n'>vector</span><span class='o'>&lt;</span><span class='kt'>int</span><span class='o'>&gt;</span><span class='n'>a</span><span class='p'>,</span><span class='kt'>int</span> <span class='n'>x</span><span class='p'>)</span>
    <span class='p'>{</span>
        <span class='kt'>int</span> <span class='n'>l</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>,</span><span class='n'>r</span><span class='o'>=</span><span class='n'>a</span><span class='p'>.</span><span class='n'>size</span><span class='p'>()</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='kt'>int</span> <span class='n'>mid</span><span class='p'>;</span>
        <span class='k'>for</span><span class='p'>(;;)</span>
        <span class='p'>{</span>
            <span class='k'>if</span><span class='p'>(</span><span class='n'>l</span><span class='o'>&gt;</span><span class='n'>r</span><span class='p'>)</span> <span class='k'>return</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
            <span class='n'>mid</span><span class='o'>=</span><span class='p'>(</span><span class='n'>l</span><span class='o'>+</span><span class='n'>r</span><span class='p'>)</span><span class='o'>/</span><span class='mi'>2</span><span class='p'>;</span>
            <span class='k'>if</span><span class='p'>(</span><span class='n'>mid</span><span class='o'>==</span><span class='mi'>0</span><span class='p'>)</span>
            <span class='p'>{</span>
                <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>==</span><span class='n'>x</span><span class='p'>)</span> <span class='k'>return</span> <span class='n'>mid</span><span class='p'>;</span>
                <span class='k'>else</span> <span class='k'>return</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
            <span class='p'>}</span>    
            <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>=</span><span class='n'>mid</span><span class='o'>+</span><span class='mi'>1</span><span class='p'>;</span>
            <span class='k'>else</span> <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>==</span><span class='n'>x</span><span class='p'>)</span>
            <span class='p'>{</span>
                <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='k'>return</span> <span class='n'>mid</span><span class='p'>;</span>
                <span class='k'>else</span> <span class='n'>r</span><span class='o'>=</span><span class='n'>mid</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
            <span class='p'>}</span>
            <span class='k'>else</span> <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>&gt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>r</span><span class='o'>=</span><span class='n'>mid</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='p'>}</span>
        <span class='k'>return</span> <span class='n'>mid</span><span class='p'>;</span>
    <span class='p'>}</span>
    
</code></pre></div>
<p>但是看了《编程珠玑(第二版)》的答案后，发现答案的方法比我的思路还有效率都清晰多了：</p>

<p>初始的循环不变式是：<code>a[l]&lt;x &amp;&amp; a[r]&gt;=x &amp;&amp; l&lt;r</code>,代码如下：</p>
<div class='highlight'><pre><code class='c++'>    <span class='kt'>int</span> <span class='nf'>bSearch3</span><span class='p'>(</span><span class='n'>vector</span><span class='o'>&lt;</span><span class='kt'>int</span><span class='o'>&gt;</span><span class='n'>a</span><span class='p'>,</span><span class='kt'>int</span> <span class='n'>x</span><span class='p'>)</span>
    <span class='p'>{</span>
        <span class='kt'>int</span> <span class='n'>l</span><span class='o'>=-</span><span class='mi'>1</span><span class='p'>,</span><span class='n'>r</span><span class='o'>=</span><span class='n'>a</span><span class='p'>.</span><span class='n'>size</span><span class='p'>();</span>
        <span class='kt'>int</span> <span class='n'>mid</span><span class='p'>;</span>
        <span class='k'>while</span><span class='p'>(</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>1</span><span class='o'>!=</span><span class='n'>r</span><span class='p'>)</span>
        <span class='p'>{</span>
            <span class='n'>mid</span><span class='o'>=</span><span class='p'>(</span><span class='n'>l</span><span class='o'>+</span><span class='n'>r</span><span class='p'>)</span><span class='o'>/</span><span class='mi'>2</span><span class='p'>;</span>
            <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>mid</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>=</span><span class='n'>mid</span><span class='p'>;</span>
            <span class='k'>else</span> <span class='n'>r</span><span class='o'>=</span><span class='n'>mid</span><span class='p'>;</span>
        <span class='p'>}</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>r</span><span class='o'>&gt;=</span><span class='n'>a</span><span class='p'>.</span><span class='n'>size</span><span class='p'>()</span> <span class='o'>||</span> <span class='n'>a</span><span class='p'>[</span><span class='n'>r</span><span class='p'>]</span><span class='o'>!=</span><span class='n'>x</span><span class='p'>)</span> <span class='k'>return</span> <span class='o'>-</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='k'>return</span> <span class='n'>r</span><span class='p'>;</span>
    <span class='p'>}</span>
    
</code></pre></div>
<p>一般的程序用这个就已经很好了，因为相比于bSearch2，bSearch3每次迭代只比较一次。</p>

<p>当然，书中还提到了进一步的优化，最终将结合搜索数组的大小，将循环展开，这样可以借助于现在计算机的流水线处理技术来增加指令集的并行，从而进一步的优化，不过一般情况下bSearch3的表现就已经相当出色，而且更容易编写和实现。</p>
<div class='highlight'><pre><code class='c++'>    <span class='kt'>int</span> <span class='nf'>bSearch4</span><span class='p'>(</span><span class='n'>vector</span><span class='o'>&lt;</span><span class='kt'>int</span><span class='o'>&gt;</span><span class='n'>a</span><span class='p'>,</span><span class='kt'>int</span> <span class='n'>x</span><span class='p'>)</span>
    <span class='p'>{</span>
        <span class='kt'>int</span> <span class='n'>l</span><span class='o'>=-</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='mi'>512</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>=</span><span class='mi'>1000</span><span class='o'>-</span><span class='mi'>512</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>256</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>256</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>128</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>128</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>64</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>64</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>32</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>32</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>16</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>16</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>8</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>8</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>4</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>4</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>2</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>2</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>a</span><span class='p'>[</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>1</span><span class='p'>]</span><span class='o'>&lt;</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>l</span><span class='o'>+=</span><span class='mi'>1</span><span class='p'>;</span>
     
        <span class='kt'>int</span> <span class='n'>p</span><span class='o'>=</span><span class='n'>l</span><span class='o'>+</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='k'>if</span><span class='p'>(</span><span class='n'>p</span><span class='o'>&gt;</span><span class='mi'>1000</span> <span class='o'>||</span> <span class='n'>a</span><span class='p'>[</span><span class='n'>p</span><span class='p'>]</span><span class='o'>!=</span><span class='n'>x</span><span class='p'>)</span> <span class='n'>p</span><span class='o'>=-</span><span class='mi'>1</span><span class='p'>;</span>
        <span class='k'>return</span> <span class='n'>p</span><span class='p'>;</span>
    <span class='p'>}</span>
    
</code></pre></div>
<p>这是一个1000个数据的二分查找的优化。</p>
</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>06 Apr 2012</span> &raquo; <a href="/blog/2012/04/06/tcpdump%E6%9F%A5%E7%9C%8B%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B">tcpdump查看三次握手</a></li>
    
      <li><span>29 Dec 2011</span> &raquo; <a href="/blog/2011/12/29/jekyll-introduction">Jekyll Introduction</a></li>
    
      <li><span>14 Jun 2011</span> &raquo; <a href="/blog/2011/06/14/kmp%E7%AE%97%E6%B3%95%E5%B0%8F%E7%BB%93">KMP算法小结</a></li>
    
  </ul>
</div>




  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'chaoswork'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>





  
    <div class="footer">
      <div class="contact">
        <p>
          Huang Chao<br />
          Site Tagline<br />
          <a href='mailto:huangchao.cpp@gmail.com'>huangchao.cpp@gmail.com</a>
        </p>
      </div>
      <div class="contact">
        <p>
          <a href="http://github.com/chaoswork/">github.com/chaoswork</a><br />
          <a href="http://twitter.com/huangchao/">twitter.com/huangchao</a><br />
        </p>
      </div>
      <div class="rss">
        <a href="http://feeds.feedburner.com/feedname">
          <img src="/assets/themes/tom/images/rss.png" alt="Subscribe to RSS Feed" />
        </a>
      </div>
    </div>
  </div>
  <a href="http://github.com/chaoswork"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

  
</body>
</html>

